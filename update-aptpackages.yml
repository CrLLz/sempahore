- hosts: "{{ my_hosts | d([]) }}"
#- hosts: all

  tasks:
    # Upgrade packages
    - name: upgrade apt packages
      become: true
      apt:
        upgrade: yes
        update_cache: yes

    # Check if reboot is required
    - name: check if system reboot is required
      become: true
      stat:
        path: /var/run/reboot-required
      register: reboot_required

    - name: notify discord
      vars:
      notify_discord_username: Ansible
      notify_discord_webhook_id: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          62393238373735663734663138313066663538363366356237653837353538303866313035626138
          3834313962323531306135333639666530353636643762620a386331633162313333663031613564
          30653138316361313139663935316138643730653034383337376236346231613333666139666431
          3736383764653338610a313161373036656366613434333839633633633561343130343137323338
          38393065623865663138356533636461613838663561663233663961323164636136
      notify_discord_webhook_token: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          66643838623030626264336363363036303862356433303532396463363335336363633333363738
          3334343262313237353962363362303466343333616432660a323131663637326263323361313765
          62303130303033393964346362643462613261326162336265616466383631353763646461393333
          6439636561353635380a326632346265386339643630636665323462626438656166333333373635
          35356366613636363530613562363038346163613964373138643865636364353839333032613033
          35626230623133653864653163316661616264613261303662613030366237366337306338373763
          35396236353237336464316432636530323432376138323035633762393232633636316561653338
          35643363353666323730
      notify_discord_webhook_id_regex: '^0|[1-9][0-9]*$'
      notify_discord_webhook_token_regex: '^[a-zA-Z0-9_-]+$'
      notify_discord_webhook_content: 'Reboot required on {{ inventory_hostname }}'
      notify_discord_send_from_host: localhost

    - name: Send Discord message
      community.general.discord:
        username: "{{ notify_discord_username }}"
        webhook_id: "{{ notify_discord_webhook_id }}"
        webhook_token: "{{ notify_discord_webhook_token }}"
        content: "{{ notify_discord_webhook_content }}"
      delegate_to: "{{ notify_discord_send_from_host }}"
      when:
        - notify_discord_webhook_id is match(notify_discord_webhook_id_regex)
        - notify_discord_webhook_token is match(notify_discord_webhook_token_regex)
        - notify_discord_webhook_content | length > 0
        - notify_discord_send_from_host is in (['localhost'] + groups['all'])
        - reboot_required.stat.exists
